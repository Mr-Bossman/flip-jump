start:
startup


// mul
ADD_MUL_NUM = 0x13762222597478827273964586609667746261076159906103295246146498313006009027370879739049299768743532028013097420991908184228734231340249470068730930421294852428945780217898559510766158158309746548329620653323558507938254182540256791667112546980649940689889156718247651655686717590906750165209562117497526094265509383796793296027188665539264953913810089258228559353
rep(100, i) test_add_mul (ADD_MUL_NUM>>(3*4*i+8))&0xf, (ADD_MUL_NUM>>(3*4*i+4))&0xf, (ADD_MUL_NUM>>(3*4*i))&0xf
//rep(100, i) output '='
output '\n'
ADD_MUL_64_NUM = 0x44515878153025976458026032910921836569080810712195579797321738072586632628656768101950569587658749604314760930892360113207423450869919969630375995848148608225731167612043307796009460607066106408836217639539772746777143384801675728686018401175639650031323058258774978114125919703443980982328419254193490638853461728339734491872291037363247586442464524583118823816462954408193558324726222815253076343012553335637307744147557245915472117673396009157754324545028103843363879967106603730002015562872587004148205040285734786905147903407131859632964029570924647373979313319625080021298939208290762743821821732459811071623177938609567526894933620583689567032031384160884891735810939301800512752217808810705286319327670273592588101518346322394292677848184400557039739534560810547781475967334052587242913385027495066376726829581028355729045730156546262272414458439643584318426201936869451744795087168874648004348059777114123047284204345333538911945730111155410972329233409665400061155380982281752164756643018472046186790597170464599404456460594804652591145400289991202604565419907678448340839748837038931885747521560000472651610283281460088571427171823942942906487172867811045931635413169026300424674655810446605566196007524688261632320724394873070966208298375978680179888083963120978418735685477574354483379210823889478380760024286914904279234154291167275369433490334117022372700830722511805729267958093801470061969913908875413437019198271722446495696263893047052198484974299177907003868640681901086421459246861416333107481901453742331049872408601901208071952180167021587478533338815816454971386793954255260760047966261316478495791104856650179640556686784989467612908004665994949584647266488923677940804419531254534625488855023465602020024424656139291075868587270596597775864173308817939323512369731219895428040025311944384780287141815050463184000833397552885242649871445766824441508000377110577590275538610925810739574619722603297808668498060684924258562220581516773024341828569292803409310886539145636597510432979387844116020684647084070341044481673981815160492735490634510372557108921178710907292455541338820798748483207225279412737620055909335002954771795080414972827707681125036742130507340359515295416786510134125387806302934604214550542769362927686947870717939985967865575826585316142786213742641341894188174493578703987199108624105388039319724776920347176183359848531724953295359297878111009908377653314260558767668686890820417129992072303425038416518914510694729441924253513678443859759746185498284194288413987990431032513912505462059790887157351009750143502574082651867305211232959409580967621809956659182497549123282656376229385858259601882600315874773696309952881487015122283263155983908758677633976669420836762649435225061255183283427859019440687849108835553279660034211317009221744846080046388976227612005720015157833358426538728958788171111891506254792815265518546635886102766001324122547480562760358938870055190024961631870302090802095789238948075135116658088074175044502664068582067644934079068831016514545887798300498552831592846381063256025131540567279520292475445998486220733852442275244292986620317923528301151203201884195903205330008239386321227736064580517669776855795307762159655476667331604325153549436893688117285445562825699380395164392596524132989724925828322188423541286891248367554316444900109060413332742832053867917952360631150424335200487768804355588099880476824535918178390046544172669440763499047589471427802760841094081475794753060620396988233172126381345664130898923374828110467329769816928397883326080734968903756843757886379964519137300703443237905703345921157789876529420340407434868630989932674706043826889504891762951384374579674180474877171950740273614541425287661288215060108056564524465585945990236549918850613741278575150496587784502023700009587774291838305151908527826309501022847002521672770130499655134478689875610408550026516321142150511395702435423509029750949675115791299768497068359760916378353955063938345855960633537083997222016545758309578512247788566651505078881840863418607346340194330105800795548465256703382636860252938170978057707745040063526436266562143627213837426978155322293164203520424122489247900755451498060314193792219359727606271089901250177668575094989381831951377607295206645764089318668380100609714529216437061211670650046632009861542478630419452116071384923965560603732551101886978504548332510800446161832255282882565386691490370823137190621979037424511384327847374436061603838426757498471110981199135460955826638869779993439702476710666034636719794911112344100416682932742577741780234789235490592149788885798120923760648493280805820392815171641718648818351076691049844994911481636519873101389053190866399245003227954205459854503383677308044449853902842625328732302932203783538303687053984549666865557372035908951469512459974628374620360084258819205585436467637695533844106994758218319705309883359524126011143206114290540791850548130297494337196389518964650592964638176869033712405264182326614388199372355483797925130100684014162429221608443160676938756845348739605846704851080367545538837501057826109532265792463515171199479067271494017300204107519931841067145566613155139607607853471913915740950327806040907963632741037393613460589547402321724822487072198222587040577998034796050262235427159495222072717778413519486051330483545589007813421477515589842985738635989766452909272627637709917900564132739239499701705618042878422053579696858200311489712859121069466873018657455049273546774491147144426071209269066668203631358975376052335128296106615110693302412327025417122739338531476605005818454000806348508963557437218143345038850564614765805139206787818458655832116842688062550178191172788186140
rep(100, i) test_add_mul_64 (ADD_MUL_64_NUM>>((3*i+2)*64))&0xf, (ADD_MUL_64_NUM>>((3*i+1)*64))&0xf, (ADD_MUL_64_NUM>>((3*i)*64))&0xf
//rep(100, i) output '='
output '\n'
MUL_NUM = 0x2437824380132744357025200101109137014950727392786132023039161600854448601549881954496543822664864644527617238186937190192551473319301531171636205861467096172928825132457586189662263656091041331292807214369557127925824201905416709620914915214611308771472657263467510878378164930898699506257387690786790453076772149270917957308038722084021948712277515156640374252105911210281194816299155833285444935261849982982552924658722207120144579611461954388139010421570691354508122146044259181418037002664191299645505985084892665745668578046247831761105184407655204640715547394610604789409872379770533645358408690212428491515673007237918258933829355126524002761133715278747692532615418720884476347848402801993328831792668383601197423710230314182677599364643102107286285049617097458086034505453090946020735586914560056241381275258836214549518196753289436531401252414830240173164958168691562557119285282275330268442070901972696518426264583993778447825076123005337276969832607178590488884864761144929334205895407721292729162099221934700068670096856586505238794164406295434171830594080526985323109350083207276590010487726751092493756987099192862677762162570733258384412094046199742364481100624253240979753063571439555361841855303732934054028971930723609689411454600061867442755741071915854806846072043916740256445681301616329539905264772550936730228276267208692465073478164266116476951053814301379242335470938048736765575045684734711016875733625584118888608972906473863041018408083827145345889801496990161562500547993594518501846414928571802414418203787652036151560469811402659551232431360569726862127031466964116797614530231124875232086259812720785345772970043042029468794557348798866425974981311299895523565469597598539576055841320101893352998778112140121838750514064511005136265788947571940363786603083697874550424997783850405507327828670784996377215201001851730252148818634787942939017085068663092200792931197980882752030979072027482861084
rep(60, i) test_mul 4, mul4, (MUL_NUM>>(32*i))&((1<<16)-1), (MUL_NUM>>(32*i+16))&((1<<16)-1)
rep(40, i) test_mul 8, mul8, (MUL_NUM>>(64*i))&((1<<32)-1), (MUL_NUM>>(64*i+32))&((1<<32)-1)
//rep(100, i) output '='
output '\n'
output '\n'


// TODO - test div
output '\n'
output '\n'


loop
hex.init

ah:  hex.vec 16
bh:  hex.vec 16
res: hex.vec 16
ch:  hex.vec 16

ret: ;0

zero_all_4:
    hex.zero 16, ah
    hex.zero 16, bh
    hex.zero 16, ch
    hex.zero 16, res
    fret ret

mul4:
    hex.mul 4, res, ah, bh
    fret ret

mul8:
    hex.mul 8, res, ah, bh
    fret ret

add_mul:
    hex.mul.clear_carry
    hex.xor hex.mul.dst, bh
    hex.add_mul res, ah
    hex.xor hex.mul.dst, bh
    hex.mul.clear_carry
    fret ret

add_mul_64:
    hex.add_mul 16, res, ah, bh
    fret ret

lt_print:
    output '\n'
    hex.print_as_digit 16, ah, 0
    output '*'
    hex.print_as_digit 16, bh, 0
    output '='
    hex.print_as_digit 16, res, 0
    output '<'
    hex.print_as_digit 16, ch, 0
    output '\n'
    fret ret

gt_print:
    output '\n'
    hex.print_as_digit 16, ah, 0
    output '*'
    hex.print_as_digit 16, bh, 0
    output '='
    hex.print_as_digit 16, res, 0
    output '>'
    hex.print_as_digit 16, ch, 0
    output '\n'
    fret ret

add_mul_lt_print:
    output '\n'
    output_str "old_res+"
    hex.print_as_digit 16, ah, 0
    output '*'
    hex.print_as_digit 16, bh, 0
    output '='
    hex.print_as_digit 16, res, 0
    output '<'
    hex.print_as_digit 16, ch, 0
    output '\n'
    fret ret

add_mul_gt_print:
    output '\n'
    output_str "old_res+"
    hex.print_as_digit 16, ah, 0
    output '*'
    hex.print_as_digit 16, bh, 0
    output '='
    hex.print_as_digit 16, res, 0
    output '>'
    hex.print_as_digit 16, ch, 0
    output '\n'
    fret ret



def test_mul n, mul_label, a, b @ lt, eq, gt,  end < ah, bh, res, ch, ret, lt_print, gt_print {
    hex.set n, ah, a
    hex.set n, bh, b
    hex.set n, ch, (a*b)&((1<<(4*n))-1)
    fcall mul_label, ret
    hex.cmp n, res, ch, lt, eq, gt

  lt:
    fcall lt_print, ret
    ;end
  eq:
    output '='
    ;end
  gt:
    fcall gt_print, ret
    ;end
  end:
}

def test_add_mul r, a, b @ lt, eq, gt,  end < ah, bh, res, ch, ret, add_mul_lt_print, add_mul_gt_print, add_mul {
    hex.set ah,  a
    hex.set bh,  b
    hex.set res, r
    hex.set ch, (r+a*b)&0xf
    fcall add_mul, ret
    hex.cmp res, ch, lt, eq, gt

  lt:
    fcall add_mul_lt_print, ret
    ;end
  eq:
    output '='
    ;end
  gt:
    fcall add_mul_gt_print, ret
    ;end
  end:
}

def test_add_mul_64 r, a, b @ lt, eq, gt,  end < ah, bh, res, ch, ret, add_mul_lt_print, add_mul_gt_print, add_mul_64, zero_all_4 {
    fcall zero_all_4, ret
    hex.xor_by 16, ah,  a
    hex.xor_by 16, bh,  b
    hex.xor_by 16, res, r
    hex.xor_by 16, ch, (r+a*b)&((1<<64)-1)
    fcall add_mul_64, ret
    hex.cmp 16, res, ch, lt, eq, gt

  lt:
    fcall add_mul_lt_print, ret
    ;end
  eq:
    output '='
    ;end
  gt:
    fcall add_mul_gt_print, ret
    ;end
  end:
}
